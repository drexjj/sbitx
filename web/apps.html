<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>sBit-Xlauncher</title>
    <style>
        body {
            font-family: 'Fira Code', 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #d0d0d0;
            margin: 0;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        #smoke-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.5;
        }
        h1 {
            color: #ffffff;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 4px rgba(255, 255, 255, 0.5);
        }
        .app-list {
            width: 100%;
            max-width: 600px;
            background-color: rgba(42, 42, 42, 0.85);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 0.5rem;
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .app-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #444;
        }
        .app-item:last-child {
            border-bottom: none;
        }
        .app-name {
            font-family: 'Arial', sans-serif;
            font-size: 1rem;
            font-weight: bold;
            margin: 0;
            color: #d0d0d0;
        }
        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cc0000;
            border: 2px solid #444;
            border-radius: 12px;
            transition: background-color 0.4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            /* Center the knob vertically */
            top: 50%;
            transform: translateY(-50%);
            background-color: #fff;
            border-radius: 50%;
            transition: transform 0.4s, left 0.4s;
        }
        input:checked + .slider {
            background-color: #00cc00;
            border-color: #00cc00;
        }
        input:checked + .slider:before {
            left: 28px;
            transform: translateY(-50%);
        }
        .toggle-switch input:disabled + .slider {
            opacity: 0.6;
            cursor: not-allowed;
        }
        /* VNC Link */
        #vnc-link {
            margin-top: 1rem;
            display: inline-block;
            padding: 0.8rem 1.5rem;
            background-color: #0066cc;
            color: #fff;
            text-decoration: none;
            border: 2px solid #0066cc;
            border-radius: 4px;
            min-height: 44px;
            line-height: 1.2;
            font-family: inherit;
            text-transform: uppercase;
        }
        #vnc-link:hover,
        #vnc-link:active {
            background-color: #0055b3;
            border-color: #0055b3;
        }
        .loading-indicator {
            padding: 1rem;
            text-align: center;
            color: #888;
            font-style: italic;
            font-size: 1rem;
        }
        .error-message {
            padding: 1rem;
            text-align: center;
            color: #cc0000;
            background-color: #3a1a1a;
            border: 1px solid #cc0000;
            border-radius: 4px;
            margin: 1rem 0;
            font-size: 1rem;
        }
        footer {
            margin-top: 2rem;
            padding: 1rem;
            text-align: center;
            color: #d0d0d0;
            font-size: 0.9rem;
            font-family: 'Arial', sans-serif;
        }
        /* Media Queries */
        @media (max-width: 600px) {
            h1 {
                font-size: 1.6rem;
            }
            .app-name {
                font-size: 0.9rem;
            }
            .app-item {
                padding: 0.3rem 0.8rem;
            }
            footer {
                font-size: 0.8rem;
            }
        }
        @media (max-width: 400px) {
            .app-list {
                max-width: 100%;
            }
            .app-item {
                flex-direction: row;
                align-items: center;
            }
            .toggle-switch {
                margin-top: 0;
            }
        }
    </style>
</head>
<body>
    <canvas id="smoke-canvas"></canvas>
    <h1>sBit-Xlauncher</h1>
    <div id="app-containers">
        <div class="loading-indicator">Loading applications...</div>
    </div>
    <footer>
        Created by W2JON and W9JES for the sBitx transceiver
    </footer>

    <script>
        let appList = [];
        
        async function loadAppList() {
            try {
                const response = await fetch('/app-list');
                appList = await response.json();
                generateAppContainers();
                updateStatus();
            } catch (error) {
                console.error('Failed to load app list:', error);
                document.getElementById('app-containers').innerHTML = 
                    '<div class="error-message">Failed to load applications. Please refresh the page to try again.</div>';
            }
        }
        
        function generateAppContainers() {
            const container = document.getElementById('app-containers');
            container.innerHTML = '';
            const appListDiv = document.createElement('div');
            appListDiv.className = 'app-list';
            
            appList.forEach(app => {
                const appItem = document.createElement('div');
                appItem.className = 'app-item';
                
                const appName = document.createElement('span');
                appName.className = 'app-name';
                // Rename "Main vnc" to "Radio Screen"
                appName.textContent = app.name === 'Main vnc' ? 'Radio Screen' : app.name;
                
                const toggleSwitch = document.createElement('label');
                toggleSwitch.className = 'toggle-switch';
                
                const toggleInput = document.createElement('input');
                toggleInput.type = 'checkbox';
                toggleInput.id = `${app.id}-toggle`;
                toggleInput.setAttribute('aria-label', `Toggle ${appName.textContent} application`);
                toggleInput.onchange = () => {
                    const action = toggleInput.checked ? 'start' : 'stop';
                    controlApp(app.id, action, app.vncPort, app.wsPort);
                };
                
                const slider = document.createElement('span');
                slider.className = 'slider';
                
                toggleSwitch.appendChild(toggleInput);
                toggleSwitch.appendChild(slider);
                
                appItem.appendChild(appName);
                appItem.appendChild(toggleSwitch);
                appListDiv.appendChild(appItem);
            });
            
            container.appendChild(appListDiv);
        }
        
        async function controlApp(app, action, vncPort, webPort) {
            try {
                const appName = app.replace('-', '_');
                const script = `${action}_${appName}.sh`;
                const response = await fetch('/execute-script', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `script=${encodeURIComponent(script)}`
                });
                const result = await response.json();

                if (result.status === 'success' && action === 'start') {
                    try {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        const vncUrl = `http://sbitx.local:${webPort}/vnc.html?autoconnect=true&resize=scale&scale=auto&quality=8&compression=0&password=sbitx&view_only=0&shared=1`;
                        const newWindow = window.open(vncUrl, '_blank');
                        
                        if (!newWindow) {
                            console.log('Popup blocked! Please allow popups for this site to use the VNC viewer.');
                        } else {
                            const checkWindowInterval = setInterval(() => {
                                if (newWindow.closed) {
                                    clearInterval(checkWindowInterval);
                                    console.log(`NoVNC window for ${app} was closed, stopping the application`);
                                    controlApp(app, 'stop');
                                }
                            }, 2000);
                        }
                    } catch (error) {
                        console.error('Error starting VNC connection:', error.message);
                    }
                }

                updateStatus();
            } catch (error) {
                console.error('Error:', error.message);
                updateStatus();
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/app-status');
                const status = await response.json();

                appList.forEach(app => {
                    // Skip status updates for "Main vnc" (now "Radio Screen")
                    if (app.name === 'Main vnc') {
                        return;
                    }
                    const toggleInput = document.getElementById(`${app.id}-toggle`);
                    if (toggleInput) {
                        const isRunning = status[app.id] === true;
                        toggleInput.checked = isRunning;
                    }
                });
            } catch (error) {
                console.error('Status update failed:', error);
            }
        }

        setInterval(updateStatus, 6000);
        document.addEventListener('DOMContentLoaded', () => {
            loadAppList();
            initSmokeEffect();
        });
        
        // Smoke effect implementation
        function initSmokeEffect() {
            const canvas = document.getElementById('smoke-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = [];
            const particleCount = 50;
            
            // Create particles
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: canvas.height + Math.random() * 100,
                    size: Math.random() * 15 + 10,
                    speed: Math.random() * 1.5 + 0.5,
                    opacity: Math.random() * 0.4 + 0.1,
                    color: Math.random() > 0.5 ? '#3366cc' : '#336699',
                    rotation: Math.random() * Math.PI * 2
                });
            }
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Update and draw particles
                for (let i = 0; i < particles.length; i++) {
                    const p = particles[i];
                    
                    // Move particles upward
                    p.y -= p.speed;
                    p.x += Math.sin(p.y * 0.01) * 0.5;
                    p.rotation += 0.005;
                    
                    // Reset particles that go off screen
                    if (p.y < -50) {
                        p.y = canvas.height + Math.random() * 50;
                        p.x = Math.random() * canvas.width;
                    }
                    
                    // Draw number 5 as particle
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation);
                    ctx.font = `${p.size}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.opacity;
                    ctx.fillText('5', 0, 0);
                    ctx.restore();
                }
                
                requestAnimationFrame(animate);
            }
            
            // Handle window resize
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
            
            animate();
        }
    </script>
</body>
</html>